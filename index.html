<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>小朋友生活管理系統（Firebase 版）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js"></script>
  <style>body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }</style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>
  <script type="text/babel">
    window.addEventListener('DOMContentLoaded', () => {
      const firebaseConfig = {
        apiKey: "AIzaSyA-Hb_ik32Gatq2qDVcWJffNrqYhY0nlhs",
        authDomain: "smt-manager.firebaseapp.com",
        projectId: "smt-manager",
        storageBucket: "smt-manager.firebasestorage.app",
        messagingSenderId: "281381699788",
        appId: "1:281381699788:web:b637dd7af978e94ab08269",
        measurementId: "G-R01ZLTFH94"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const auth = firebase.auth();

      const getDateString = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };

      const TaskEditor = ({ child, onUpdate }) => {
        const [newTaskName, setNewTaskName] = React.useState("");
        const [newTaskPoints, setNewTaskPoints] = React.useState(1);

        const handleAdd = () => {
          if (!newTaskName.trim()) return;
          const newTask = { id: `task-${Date.now()}`, name: newTaskName, points: newTaskPoints, isCustomizable: true };
          const updated = {
            ...child,
            masterTasks: [...child.masterTasks, newTask]
          };
          onUpdate(updated);
          setNewTaskName("");
          setNewTaskPoints(1);
        };

        const handleDelete = (taskId) => {
          const updated = {
            ...child,
            masterTasks: child.masterTasks.filter(t => t.id !== taskId)
          };
          onUpdate(updated);
        };

        return (
          <div className="bg-white p-4 rounded shadow mt-4">
            <h3 className="text-lg font-bold mb-2">任務管理</h3>
            <ul className="mb-4">
              {child.masterTasks.map(task => (
                <li key={task.id} className="flex justify-between items-center py-1">
                  <span>{task.name}（{task.points} 點）</span>
                  <button className="text-red-500" onClick={() => handleDelete(task.id)}>刪除</button>
                </li>
              ))}
            </ul>
            <div className="flex gap-2">
              <input type="text" className="border p-1 flex-grow" value={newTaskName} onChange={(e) => setNewTaskName(e.target.value)} placeholder="新任務名稱" />
              <input type="number" className="border p-1 w-16" value={newTaskPoints} onChange={(e) => setNewTaskPoints(Number(e.target.value))} min="1" />
              <button className="bg-blue-500 text-white px-3 py-1 rounded" onClick={handleAdd}>新增</button>
            </div>
          </div>
        );
      };

      const App = () => {
        const [children, setChildren] = React.useState([]);
        const [isLoading, setIsLoading] = React.useState(true);
        const [user, setUser] = React.useState(null);

        React.useEffect(() => {
          const unsubscribe = auth.onAuthStateChanged((firebaseUser) => {
            if (firebaseUser) {
              setUser(firebaseUser);
            } else {
              auth.signInAnonymously();
            }
          });
          return () => unsubscribe();
        }, []);

        React.useEffect(() => {
          if (!user) return;
          const unsubscribe = db.collection("children")
            .where("owner", "==", user.uid)
            .onSnapshot(async (snapshot) => {
              let data = snapshot.docs.map(doc => doc.data());

              if (data.length === 0) {
                data = [
                  { id: 'ting-yu', name: '庭伃', totalPoints: 0, masterTasks: defaultTasks(), masterBadBehaviors: defaultBads(), dailyRecords: {}, redemptionHistory: [], owner: user.uid },
                  { id: 'ke-fu', name: '科甫', totalPoints: 0, masterTasks: defaultTasks(), masterBadBehaviors: defaultBads(), dailyRecords: {}, redemptionHistory: [], owner: user.uid }
                ];
                for (const child of data) {
                  await db.collection("children").doc(child.id).set(child);
                }
              }

              setChildren(data);
              setIsLoading(false);
            });

          return () => unsubscribe();
        }, [user]);

        const updateChild = async (updatedChild) => {
          try {
            await db.collection("children").doc(updatedChild.id).set(updatedChild);
          } catch (err) {
            console.error("更新錯誤", err);
          }
        };

        const totalPoints = children.reduce((sum, c) => sum + (c.totalPoints || 0), 0);

        return isLoading ? <div className="flex justify-center items-center h-screen text-xl">載入中...</div> : (
          <div className="p-6 max-w-4xl mx-auto">
            <h1 className="text-3xl font-bold mb-4">小朋友生活管理</h1>
            <div className="bg-white p-4 rounded shadow mb-6">
              <p className="text-lg font-medium">目前總點數：<span className="text-green-600 font-bold">{totalPoints}</span></p>
              <p className="text-sm text-gray-500">已登入為匿名帳戶（UID: {user?.uid.slice(0, 6)}...）</p>
            </div>
            {children.map(child => (
              <div key={child.id} className="bg-white p-4 mb-4 rounded shadow">
                <h2 className="text-xl font-bold mb-2">{child.name}</h2>
                <p className="text-gray-700">總點數：{child.totalPoints}</p>
                <TaskEditor child={child} onUpdate={updateChild} />
              </div>
            ))}
          </div>
        );
      };

      const defaultTasks = () => [
        { id: 'task-1', name: '針對自己的設立的活動目標練習', isCustomizable: true, points: 5 },
        { id: 'task-2', name: '複習自己設定的功課(家長指定亦可)', isCustomizable: true, points: 5 },
        { id: 'task-3', name: '睡覺前整理書包及明天要穿的衣服', points: 5 },
      ];

      const defaultBads = () => [
        { id: 'bad-1', name: '哭', points: 1 },
        { id: 'bad-2', name: '不收東西', points: 1 }
      ];

      ReactDOM.render(<App />, document.getElementById('root'));
    });
  </script>
</body>
</html>
